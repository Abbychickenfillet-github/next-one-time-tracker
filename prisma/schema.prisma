generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// 以下為資料表定義
model Blog {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  title     String
  content   String?
  published Boolean  @default(false)
}

model TimeLog {
  id        Int       @id @default(autoincrement())
  title     String
  startTime DateTime  @map("start_time")
  endTime   DateTime? @map("end_time")
  userId    Int?      @map("user_id")
  memo      String?   // 新增備註欄位，用於使用者反思
  steps     Step[]
  user      User?     @relation(fields: [userId], references: [user_id], onDelete: Cascade)
}

model Step {
  id          Int       @id @default(autoincrement())
  timeLogId   Int       @map("time_log_id")
  userId      Int?      @map("user_id")
  title       String
  description String?
  startTime   DateTime  @map("start_time")
  endTime     DateTime? @map("end_time")
  timeLog     TimeLog   @relation(fields: [timeLogId], references: [id], onDelete: Cascade)
  user        User?     @relation(fields: [userId], references: [user_id], onDelete: Cascade)
}

model Brand {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  img      String?
  info     String
  products Product[]
}

model Category {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  parentId Int?      @map("parent_id")
  products Product[]
}

model Favorite {
  userId    Int     @map("user_id")
  productId Int     @map("product_id")
  product   Product @relation(fields: [productId], references: [id])
  user      User    @relation(fields: [userId], references: [user_id])

  @@id([userId, productId])
}

model Otp {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  token     String
  hash      String?
  createdAt DateTime @default(now()) @map("created_at")
  expiredAt DateTime @map("expired_at")
}

model Product {
  id         Int        @id @default(autoincrement())
  name       String
  sn         String     @unique
  photos     String?
  stock      Int        @default(0)
  price      Int        @default(0)
  info       String
  brandId    Int        @map("brand_id")
  categoryId Int        @map("category_id")
  favorites  Favorite[]
  brand      Brand      @relation(fields: [brandId], references: [id])
  category   Category   @relation(fields: [categoryId], references: [id])
}

model User {
  user_id         Int            @id @default(autoincrement())
  name            String?
  password        String
  email           String         @unique
  phone           String?
  birthdate       DateTime?
  gender          String?
  avatar          String?
  level           Int            @default(0)
  valid           Boolean        @default(true)
  createdAt       DateTime       @default(now()) @map("created_at")
  googleUid       String?        @unique @map("google_uid")
  lineUid         String?        @unique @map("line_uid")
  lineAccessToken String?
  refreshToken    String?
  iat             String?
  exp             String?
  favorites       Favorite[]
  steps           Step[]
  timeLogs        TimeLog[]
  paymentOrders   PaymentOrder[]
}

model PaymentOrder {
  id              String    @id @default(cuid())
  orderId         String    @unique // 系統內部訂單號
  userId          Int?      @map("user_id") // 關聯用戶
  amount          Int       // 訂單總金額
  currency        String    @default("TWD") // 貨幣
  status          String    @default("PENDING") // 支付狀態: PENDING, SUCCESS, FAILED, CANCELLED

  // LINE Pay 相關資訊
  transactionId   String?   @unique @map("transaction_id") // LINE Pay 交易 ID
  paymentUrl      String?   @map("payment_url") // LINE Pay 支付跳轉 URL
  returnCode      String?   @map("return_code") // LINE Pay API 返回碼
  returnMessage   String?   @map("return_message") // LINE Pay API 返回訊息
  paymentAccessToken String? @map("payment_access_token") // LINE Pay 支付存取權杖

  // 訂單詳情
  packages        Json      // 訂單商品詳情，以 JSON 格式存儲
  redirectUrls    Json?     @map("redirect_urls") // 重定向 URL 設定

  // 時間戳
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // 關聯
  user            User?     @relation(fields: [userId], references: [user_id], onDelete: SetNull)
}
