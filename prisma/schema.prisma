generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 以下為資料表定義

model TimeLog {
  id             String          @id @default(uuid()) @db.Uuid
  title          String
  startTime      DateTime        @map("start_time")
  endTime        DateTime?       @map("end_time")
  userId         String?         @map("user_id") @db.Uuid
  memo           String?
  steps          Step[]
  user           User?           @relation(fields: [userId], references: [user_id], onDelete: Cascade)
  featuredShares FeaturedShare[]
}

model Step {
  id          String    @id @default(uuid()) @db.Uuid
  timeLogId   String    @map("time_log_id") @db.Uuid
  title       String
  description String?
  startTime   DateTime  @map("start_time")
  endTime     DateTime? @map("end_time")
  timeLog     TimeLog   @relation(fields: [timeLogId], references: [id], onDelete: Cascade)
}

model Otp {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  token     String
  hash      String?
  createdAt DateTime @default(now()) @map("created_at")
  expiredAt DateTime @map("expired_at")
}

model User {
  user_id           String          @id @default(uuid()) @map("user_id") @db.Uuid
  name              String?
  password          String
  email             String          @unique
  phone             String?
  birthdate         DateTime?
  gender            String?
  avatar            String?
  level             Int             @default(0)
  valid             Boolean         @default(true)
  createdAt         DateTime        @default(now()) @map("created_at")
  googleUid         String?         @unique @map("google_uid")
  lineUid           String?         @unique @map("line_uid")
  lineAccessToken   String?
  refreshToken      String?
  iat               String?
  exp               String?
  current_log_count Int             @default(0) @map("current_log_count")
  due_date          DateTime?       @map("due_date")
  paid              Boolean         @default(false)
  paid_date         DateTime?       @map("paid_date")
  paymentOrders     PaymentOrder[]
  timeLogs          TimeLog[]
  featuredShares    FeaturedShare[]
  favorites         Favorite[]

  @@index([email])
  @@index([googleUid])
  @@index([lineUid])
}

model PaymentOrder {
  id                 String    @id @default(uuid()) @db.Uuid
  orderId            String    @unique
  userId             String?   @map("user_id") @db.Uuid
  amount             Int
  currency           String    @default("TWD")
  status             String    @default("PENDING")
  transactionId      String?   @unique @map("transaction_id")
  packages           Json
  redirectUrls       Json?     @map("redirect_urls")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  dueAt              DateTime? @map("due_at")
  isCurrent          Boolean   @default(true) @map("is_current")
  paidAt             DateTime? @map("paid_at")
  subscriptionStatus String?   @default("ACTIVE") @map("subscription_status")
  user               User?     @relation(fields: [userId], references: [user_id])

  @@index([userId, isCurrent]) // 索引：用戶ID + 是否當前訂閱
  @@index([dueAt]) // 索引：到期時間，用於查詢過期訂閱
}

model FeaturedShare {
  id          String     @id @default(uuid()) @db.Uuid
  userId      String     @map("user_id") @db.Uuid
  timeLogId   String     @map("time_log_id") @db.Uuid
  title       String // 分享標題
  description String? // 分享描述
  shareReason String?    @map("share_reason") // 分享原因
  starCount   Int        @default(0) @map("star_count") // 星星數量
  isPublic    Boolean    @default(true) @map("is_public") // 是否公開
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  user        User       @relation(fields: [userId], references: [user_id], onDelete: Cascade)
  timeLog     TimeLog    @relation(fields: [timeLogId], references: [id], onDelete: Cascade)
  favorites   Favorite[]

  @@index([userId]) // 索引：用戶ID，用於查詢用戶的分享
  @@index([isPublic, createdAt]) // 複合索引：公開狀態 + 創建時間，用於查詢公開分享
  @@index([starCount]) // 索引：星星數量，用於排序
}

model Favorite {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  featuredShareId String   @map("featured_share_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at")

  user          User          @relation(fields: [userId], references: [user_id], onDelete: Cascade)
  featuredShare FeaturedShare @relation(fields: [featuredShareId], references: [id], onDelete: Cascade)

  @@unique([userId, featuredShareId]) // 防止重複按讚
  @@index([userId]) // 快速查詢用戶的所有最愛
  @@index([featuredShareId]) // 快速查詢分享被按讚的次數
}
