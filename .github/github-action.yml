name: Build and Deploy with Email Notification

# 觸發條件：當有 push 到 main 分支時執行
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 檢出程式碼
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 設定 Node.js 環境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. 安裝依賴
      - name: Install dependencies
        run: npm ci

      # 4. 執行測試（如果有測試的話）
      - name: Run tests
        run: npm test --if-present

      # 5. 建置專案
      - name: Build project
        run: npm run build

      # 6. 建置 Docker 映像
      - name: Build Docker image
        run: |
          docker build -t next-one-app .

      # 7. 登入 Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 8. 推送到 Docker Hub
      - name: Push to Docker Hub
        run: |
          docker tag next-one-app ${{ secrets.DOCKERHUB_USERNAME }}/next-one-app:latest
          docker tag next-one-app ${{ secrets.DOCKERHUB_USERNAME }}/next-one-app:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/next-one-app:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/next-one-app:${{ github.sha }}

      # 9. 登入 GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 10. 推送到 GitHub Container Registry
      - name: Push to GitHub Container Registry
        run: |
          docker tag next-one-app ghcr.io/${{ github.repository }}/next-one-app:latest
          docker tag next-one-app ghcr.io/${{ github.repository }}/next-one-app:${{ github.sha }}
          docker push ghcr.io/${{ github.repository }}/next-one-app:latest
          docker push ghcr.io/${{ github.repository }}/next-one-app:${{ github.sha }}

      # 8. 成功後寄送通知郵件
      - name: Send success notification
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: '✅ Build Success - Next One Project'
          to: aintluminate@gmail.com
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            🎉 恭喜！你的 Next One 專案已經成功建置和部署！

            📊 建置詳情：
            - 分支：${{ github.ref_name }}
            - 提交：${{ github.sha }}
            - 觸發者：${{ github.actor }}
            - 時間：${{ github.event.head_commit.timestamp }}

            🐳 Docker 映像：
            - Docker Hub: ${{ secrets.DOCKERHUB_USERNAME }}/next-one-app:latest
            - GitHub Registry: ghcr.io/${{ github.repository }}/next-one-app:latest
            - 版本標籤: ${{ github.sha }}

            🔗 相關連結：
            - Repository: ${{ github.repository }}
            - Commit: ${{ github.event.head_commit.url }}
            - Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            建置過程一切順利！🚀

      # 9. 失敗時寄送錯誤通知
      - name: Send failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: '❌ Build Failed - Next One Project'
          to: aintluminate@gmail.com
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            😞 抱歉，你的 Next One 專案建置失敗了！

            📊 建置詳情：
            - 分支：${{ github.ref_name }}
            - 提交：${{ github.sha }}
            - 觸發者：${{ github.actor }}
            - 時間：${{ github.event.head_commit.timestamp }}

            🔗 相關連結：
            - Repository: ${{ github.repository }}
            - Commit: ${{ github.event.head_commit.url }}
            - Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            請檢查建置日誌並修復問題！🔧
