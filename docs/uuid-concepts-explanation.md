# UUID 相關概念說明

## 📚 基礎概念

### 1. **分布式系統中的 ID 碰撞問題**

#### 什麼是「多實例啟動，每個自己都自增」？

**傳統自增 ID (Auto Increment) 的問題：**

```
單一資料庫實例：
資料庫 A：
  User 1 → ID = 1
  User 2 → ID = 2
  User 3 → ID = 3

資料庫 B（另一台伺服器）：
  User 1 → ID = 1  ❌ 碰撞！
  User 2 → ID = 2  ❌ 碰撞！
```

當系統有**多個資料庫實例**（例如：多台伺服器、微服務架構），如果每個實例都從 1 開始自增，就會產生**相同的 ID**，這就是「碰撞」。

**實際例子：**

- 電子商務系統：訂單在不同伺服器上被分配相同的 ID
- 即時通訊：訊息 ID 在不同節點重複
- 微服務架構：各服務獨立產生 ID，無法保證全局唯一

### 2. **解決方案比較**

#### ❌ Auto Increment（自動遞增）

```javascript
// 單一資料庫
id: Int @default(autoincrement())  // 1, 2, 3, 4...
```

**優點：**

- 簡單、快速
- 可以排序
- 儲存空間小

**缺點：**

- 只適用單一資料庫
- 分散式系統會碰撞
- 暴露業務資訊（可猜測訂單數量）

#### ✅ UUID（通用唯一識別碼）

```javascript
// 分散式系統
id: String @default(uuid()) @db.Uuid  // "550e8400-e29b-41d4-a716-446655440000"
```

**優點：**

- 全局唯一（即使在不同伺服器）
- 不可預測（安全性好）
- 不需要集中管理

**缺點：**

- 無法排序（亂序）
- 儲存空間大（128 bits）
- 效能較差（字串比較比整數慢）

#### ✅ 雪花算法（Snowflake）

```
64 bits = 時間戳(41) + 機器ID(10) + 序列號(12)
```

**優點：**

- 全局唯一
- **可排序**（時間順序）
- 效能好（整數運算）
- 儲存空間小（64 bits）

**缺點：**

- 需要配置機器 ID
- 時鐘同步問題

## 🔢 UUID 的五個版本

根據 [RFC 4122](https://www.rfc-editor.org/rfc/rfc4122) 和 [這篇文章](https://medium.com/%E9%96%92%E8%AB%87%E8%BB%9F%E9%AB%94%E6%9E%B6%E6%A7%8B/%E9%96%92%E8%AB%87%E8%BB%9F%E9%AB%94%E6%9E%B6%E6%A7%8B-uuid-2748df80aa7e)：

### UUID v1：基於時間戳 + MAC 地址

```
格式：時間戳(60 bits) + 節點ID(48 bits) + 時鐘序列(14 bits)
```

- ✅ 在**特定時間區間內有順序性**
- ✅ 可識別產生節點（MAC address）
- ❌ 暴露 MAC address（安全問題）
- **範例：** `6ba7b810-9dad-11d1-80b4-00c04fd430c8`

### UUID v2：DCE 安全版本

```
基於 v1，但包含用戶/群組 ID
```

- 很少使用（DCE 專屬）

### UUID v3：基於命名空間 + MD5

```
UUID(namespace, name) = MD5(namespace + name)
```

- ✅ 相同輸入產生相同 UUID（確定性）
- ❌ 使用 MD5（已不建議）
- **用途：** 識別相同節點

### UUID v4：隨機生成（最常用）✨

```
全部隨機生成（128 bits 亂數）
```

- ✅ **最簡單、最安全**
- ✅ 不可預測
- ❌ 完全無序
- **範例：** `550e8400-e29b-41d4-a716-446655440000`

### UUID v5：基於命名空間 + SHA-1

```
UUID(namespace, name) = SHA1(namespace + name)
```

- ✅ 相同輸入產生相同 UUID（確定性）
- ✅ 使用 SHA-1（比 MD5 安全）
- **用途：** 識別相同節點

## 🎯 我們使用的是哪一個版本？

**PostgreSQL 的 `gen_random_uuid()` 函數：**

當你使用 `@default(uuid())` 時，Prisma 會呼叫 PostgreSQL 的 `gen_random_uuid()` 函數，這會產生 **UUID v4（隨機 UUID）**。

```sql
-- PostgreSQL 內部執行
SELECT gen_random_uuid();
-- 結果：550e8400-e29b-41d4-a716-446655440000 (v4)
```

**為什麼選擇 v4？**

- 最簡單（不需要配置）
- 最安全（完全隨機，不可預測）
- 最通用（大多數系統支援）

## 📊 概念對照表

| 概念                           | 說明                                 | 例子                        |
| ------------------------------ | ------------------------------------ | --------------------------- |
| **碰撞 (Collision)**           | 兩個不同的資料產生相同的 ID          | 兩個訂單都是 ID = 123       |
| **全局唯一 (Globally Unique)** | 整個系統（跨所有伺服器）都不會有重複 | UUID 在任何伺服器都不會重複 |
| **不可預測 (Unpredictable)**   | 無法猜測下一個 ID 是什麼             | UUID 看起來是亂數，無法預測 |
| **效能 (Performance)**         | 查詢和比較的速度                     | 整數比較 > UUID 字串比較    |

## 🔍 詳細說明

### 1. **碰撞 (Collision)**

**問題：**

```javascript
// 伺服器 A（台灣）
訂單 1 → ID = 1
訂單 2 → ID = 2

// 伺服器 B（美國）
訂單 1 → ID = 1  ❌ 碰撞！無法區分是哪個訂單
```

**解決：**

```javascript
// UUID 保證全局唯一
訂單 1 → ID = "550e8400-e29b-41d4-a716-446655440000"
訂單 2 → ID = "6ba7b811-9dad-11d1-80b4-00c04fd430c8"
// 即使在不同伺服器，也不會重複
```

### 2. **全局唯一 (Globally Unique)**

**意思：**

- 整個**分布式系統**（所有伺服器、所有資料庫）都不會有重複
- 不需要中央協調器（不需要單一 ID 生成服務）

**對比：**

```javascript
// Auto Increment（局部唯一）
資料庫 A：1, 2, 3...
資料庫 B：1, 2, 3...  // 可能在另一個資料庫重複

// UUID（全局唯一）
所有資料庫：每個 UUID 都不同，不會重複
```

### 3. **效能 (Performance)**

**整數 ID：**

```javascript
// 資料庫內部儲存：8 bytes (BIGINT)
// 比較運算：CPU 原生整數比較（非常快）
id = 123456789 // 8 bytes
```

**UUID：**

```javascript
// 資料庫內部儲存：16 bytes (128 bits)
// 比較運算：字串比較（較慢）
id = '550e8400-e29b-41d4-a716-446655440000' // 16 bytes + 字串格式開銷
```

**效能差異（參考文章）：**

- 排序 100 萬個 UUID 物件：**352 ms**
- 排序 100 萬個 UUID 字串：**679 ms**（約慢 2 倍）

## 🛠️ 實際應用建議

### 何時使用 UUID？

- ✅ 分布式系統（多伺服器、微服務）
- ✅ 需要安全性（不可預測 ID）
- ✅ 資料需要合併（來自不同來源）

### 何時使用 Auto Increment？

- ✅ 單一資料庫實例
- ✅ 需要排序和效能
- ✅ 不介意暴露業務資訊

### 何時使用雪花算法？

- ✅ 需要排序 + 全局唯一
- ✅ 高併發系統（每秒大量 ID）
- ✅ 可以配置機器 ID

## 📖 延伸閱讀

- [RFC 4122 - UUID 規範](https://www.rfc-editor.org/rfc/rfc4122)
- [Medium 文章：閒談軟體架構 - UUID](https://medium.com/%E9%96%92%E8%AB%87%E8%BB%9F%E9%AB%94%E6%9E%B6%E6%A7%8B/%E9%96%92%E8%AB%87%E8%BB%9F%E9%AB%94%E6%9E%B6%E6%A7%8B-uuid-2748df80aa7e)
- [Prisma UUID 文檔](https://www.prisma.io/docs/concepts/components/prisma-schema/data-model#defining-an-id-field)


